var ManipulationHelpers;!function(t){var e=BABYLON.Color3,i=BABYLON.StandardMaterial,o=BABYLON.Matrix,n=BABYLON.Mesh,r=BABYLON.Vector3,s=BABYLON.Quaternion,a=BABYLON.VertexData,h=BABYLON.LinesMesh,l=function(){function t(o,r,s,a,h,l){void 0===r&&(r=1911),this._scene=o,this._arrowLength=s?s:1,this._coneLength=a?a:.2,this._coneRadius=h?h:.1,this._planeSelectionLength=l?l:this._arrowLength/5,this._wireSelectionThreshold=.05,this._light1=new BABYLON.PointLight("ManipulatorLight",new BABYLON.Vector3(50,50,70),this._scene),this._light1.id="***SceneManipulatorLight***",this._light2=new BABYLON.PointLight("ManipulatorLight",new BABYLON.Vector3(-50,-50,-70),this._scene),this._light2.id="***SceneManipulatorLight***",this._xArrowColor=new e(t.pc,t.sc/2,t.sc),this._yArrowColor=new e(t.sc,t.pc,t.sc/2),this._zArrowColor=new e(t.sc/2,t.sc,t.pc),this._xyPlaneSelectionColor=new e(t.pc/1.1,t.pc/1.3,t.sc),this._xzPlaneSelectionColor=new e(t.pc/1.1,t.sc,t.pc/1.3),this._yzPlaneSelectionColor=new e(t.sc,t.pc/1.3,t.pc/1.1);var c=[];c.push({name:"arrowX",color:this.xArrowColor}),c.push({name:"arrowY",color:this.yArrowColor}),c.push({name:"arrowZ",color:this.zArrowColor}),c.push({name:"planeXY",color:this.xyPlaneSelectionColor}),c.push({name:"planeXZ",color:this.xzPlaneSelectionColor}),c.push({name:"planeYZ",color:this.yzPlaneSelectionColor}),c.push({name:"rotationX",color:this.xArrowColor.clone()}),c.push({name:"rotationY",color:this.yArrowColor.clone()}),c.push({name:"rotationZ",color:this.zArrowColor.clone()}),this._materials=[];for(var p=0,u=c;p<u.length;p++){var d=u[p],_=new i(d.name+"RadixMaterial",this._scene);_.diffuseColor=d.color,this._materials[d.name]=_}this._features=r,this._rootMesh=new n("radixRoot",this._scene),this._rootMesh.renderingGroupId=1,this.constructGraphicalObjects()}return Object.defineProperty(t.prototype,"wireSelectionThreshold",{get:function(){return this._wireSelectionThreshold},set:function(t){this._wireSelectionThreshold=t;for(var e=this._rootMesh.getChildMeshes(!0,function(t){return t instanceof h}),i=0,o=e;i<o.length;i++){var n=o[i],r=n;r&&(r.intersectionThreshold=t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"xArrowColor",{get:function(){return this._xArrowColor},set:function(t){this._xArrowColor=t,this.updateMaterial("arrowX",t),this.updateMaterial("rotationX",t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"yArrowColor",{get:function(){return this._yArrowColor},set:function(t){this._yArrowColor=t,this.updateMaterial("arrowY",t),this.updateMaterial("rotationY",t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zArrowColor",{get:function(){return this._zArrowColor},set:function(t){this._zArrowColor=t,this.updateMaterial("arrowZ",t),this.updateMaterial("rotationZ",t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"xyPlaneSelectionColor",{get:function(){return this._xyPlaneSelectionColor},set:function(t){this._xyPlaneSelectionColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"xzPlaneSelectionColor",{get:function(){return this._xzPlaneSelectionColor},set:function(t){this._xzPlaneSelectionColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"yzPlaneSelectionColor",{get:function(){return this._yzPlaneSelectionColor},set:function(t){this._yzPlaneSelectionColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"highlighted",{get:function(){return this._highlighted},set:function(t){this.updateMaterialFromHighlighted(1,t,"arrowX"),this.updateMaterialFromHighlighted(2,t,"arrowY"),this.updateMaterialFromHighlighted(4,t,"arrowZ"),this.updateMaterialFromHighlighted(16,t,"planeXY"),this.updateMaterialFromHighlighted(32,t,"planeXZ"),this.updateMaterialFromHighlighted(64,t,"planeYZ"),this.updateMaterialFromHighlighted(256,t,"rotationX"),this.updateMaterialFromHighlighted(512,t,"rotationY"),this.updateMaterialFromHighlighted(1024,t,"rotationZ"),this._highlighted=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"features",{get:function(){return this._features},enumerable:!0,configurable:!0}),t.prototype.intersect=function(t){var e=0,i=Number.MAX_VALUE;if(this.hasFeature(1)){var o=this.intersectMeshes(t,"arrowX",i);i>o&&(i=o,e=1)}if(this.hasFeature(2)){var o=this.intersectMeshes(t,"arrowY",i);i>o&&(i=o,e=2)}if(this.hasFeature(4)){var o=this.intersectMeshes(t,"arrowZ",i);i>o&&(i=o,e=4)}if(this.hasFeature(16)){var o=this.intersectMeshes(t,"planeXY",i);i>o&&(i=o,e=16)}if(this.hasFeature(32)){var o=this.intersectMeshes(t,"planeXZ",i);i>o&&(i=o,e=32)}if(this.hasFeature(64)){var o=this.intersectMeshes(t,"planeYZ",i);i>o&&(i=o,e=64)}if(this.hasFeature(256)){var o=this.intersectMeshes(t,"rotationX",i);i>o&&(i=o,e=256)}if(this.hasFeature(512)){var o=this.intersectMeshes(t,"rotationY",i);i>o&&(i=o,e=512)}if(this.hasFeature(1024)){var o=this.intersectMeshes(t,"rotationZ",i);i>o&&(i=o,e=1024)}return e},t.prototype.setWorld=function(t,e,i){this._rootMesh.position=t,this._rootMesh.rotationQuaternion=e,this._rootMesh.scaling=i},t.prototype.show=function(){this.setVisibleState(this._rootMesh,!0)},t.prototype.hide=function(){this.setVisibleState(this._rootMesh,!1)},t.prototype.setVisibleState=function(t,e){var i=this;t.isVisible=e,t.getChildMeshes(!0).forEach(function(t){return i.setVisibleState(t,e)})},t.prototype.intersectMeshes=function(t,e,i){for(var o=this._rootMesh.getChildMeshes(!0,function(t){return 0===t.name.indexOf(e)}),n=0,r=o;n<r.length;n++){var s=r[n],a=this._scene.createPickingRay(t.x,t.y,s.getWorldMatrix(),this._scene.activeCamera),h=s.intersects(a,!1);h.hit&&h.distance<i&&(i=h.distance)}return i},t.prototype.constructGraphicalObjects=function(){var t=Math.PI/2;this.hasFeature(1)&&this.constructArrow(1,"arrowX",o.RotationZ(-t)),this.hasFeature(2)&&this.constructArrow(2,"arrowY",o.Identity()),this.hasFeature(4)&&this.constructArrow(4,"arrowZ",o.RotationX(t)),this.hasFeature(16)&&this.constructPlaneSelection(16,"planeXY",o.Identity()),this.hasFeature(32)&&this.constructPlaneSelection(32,"planeXZ",o.RotationX(t)),this.hasFeature(64)&&this.constructPlaneSelection(64,"planeYZ",o.RotationY(-t)),this.hasFeature(256)&&this.constructRotation(256,"rotationX",o.RotationZ(-t)),this.hasFeature(512)&&this.constructRotation(512,"rotationY",o.Identity()),this.hasFeature(1024)&&this.constructRotation(1024,"rotationZ",o.RotationX(t))},t.prototype.constructArrow=function(t,e,i){var o,l=this.getMaterial(e);switch(t){case 1:o=this.hasFeature(256);break;case 2:o=this.hasFeature(512);break;case 4:o=this.hasFeature(1024)}var c=s.FromRotationMatrix(i),p=new Array;p.push(0,o?this._coneLength:0,0),p.push(0,this._arrowLength-this._coneLength,0);var u=new h(e+"Wire",this._scene);u.rotationQuaternion=c,u.parent=this._rootMesh,u.color=l.diffuseColor,u.renderingGroupId=1,u.intersectionThreshold=this.wireSelectionThreshold,u.isPickable=!1;var d=new a;d.positions=p,d.indices=[0,1],d.applyToMesh(u);var _=n.CreateCylinder(e+"Cone",this._coneLength,0,this._coneRadius,18,1,this._scene,!1);_.position=r.TransformCoordinates(new r(0,this._arrowLength-this._coneLength/2,0),i),_.rotationQuaternion=c,_.material=l,_.parent=this._rootMesh,_.renderingGroupId=1,_.isPickable=!1,this.addSymbolicMeshToLit(_)},t.prototype.constructPlaneSelection=function(t,e,i){var o=this.getMaterial(e),a=new Array;a.push(new r(this._arrowLength-this._planeSelectionLength,this._arrowLength,0)),a.push(new r(this._arrowLength,this._arrowLength,0)),a.push(new r(this._arrowLength,this._arrowLength-this._planeSelectionLength,0));var h=n.CreateLines(e+"Plane",a,this._scene);h.parent=this._rootMesh,h.color=o.diffuseColor,h.rotationQuaternion=s.FromRotationMatrix(i),h.renderingGroupId=1,h.intersectionThreshold=this.wireSelectionThreshold,h.isPickable=!1},t.prototype.constructRotation=function(t,e,i){var o=this.getMaterial(e),a=n.CreateCylinder(e+"Cylinder",this._coneLength,this._coneRadius,this._coneRadius,18,1,this._scene,!1);a.material=o,a.position=r.TransformCoordinates(new r(0,this._coneLength/2,0),i),a.rotationQuaternion=s.FromRotationMatrix(i),a.parent=this._rootMesh,a.renderingGroupId=1,a.isPickable=!1,this.addSymbolicMeshToLit(a)},t.prototype.addSymbolicMeshToLit=function(t){var e=this;this._light1.includedOnlyMeshes.push(t),this._light2.includedOnlyMeshes.push(t),this._scene.lights.map(function(i){i!==e._light1&&i!==e._light2&&i.excludedMeshes.push(t)})},t.prototype.hasFeature=function(t){return 0!==(this._features&t)},t.prototype.hasHighlightedFeature=function(t){return 0!==(this._highlighted&t)},t.prototype.updateMaterial=function(t,e){var i=this.getMaterial(t);i&&(i.diffuseColor=e)},t.prototype.updateMaterialFromHighlighted=function(t,e,i){if(this.hasFeature(t)&&(this._highlighted&t)!==(e&t)){var o=this.getMaterial(i);0!==(e&t)?(o.diffuseColor.r*=1.8,o.diffuseColor.g*=1.8,o.diffuseColor.b*=1.8):(o.diffuseColor.r/=1.8,o.diffuseColor.g/=1.8,o.diffuseColor.b/=1.8)}},t.prototype.getMaterial=function(t){var e=this._materials[t];return e},t.pc=.6,t.sc=.2,t}();t.Radix=l}(ManipulationHelpers||(ManipulationHelpers={}));var Vector4=BABYLON.Vector2,ManipulationHelpers;!function(t){var e=BABYLON.Vector2,i=BABYLON.Vector3,o=BABYLON.Matrix,n=BABYLON.Plane,r=BABYLON.AbstractMesh,s=BABYLON.Quaternion,a=BABYLON.PointerEventTypes,h=function(){function h(e){var i=this;this.noPreventContextMenu=!1,this._flags=0,this._rotationFactor=1,this._scene=e,this._radix=new t.Radix(e),this._shiftKeyState=!1,this._scene.onBeforeRenderObservable.add(function(t,e){return i.onBeforeRender(t,e)}),this._scene.onPointerObservable.add(function(t,e){return i.onPointer(t,e)},-1,!0),window.oncontextmenu=function(t){i.noPreventContextMenu||t.preventDefault()}}return h.prototype.attachManipulatedNode=function(t){this._manipulatedNode=t,this._radix.show()},h.prototype.detachManipulatedNode=function(t){this._manipulatedNode=null,this._radix.hide()},h.prototype.onBeforeRender=function(t,e){this.renderManipulator()},h.prototype.onPointer=function(t,e){if(this._manipulatedNode){var i=this.getRayPosition(t.event),o=t.event.shiftKey;this.hasManFlags(1)&&o!==this._shiftKeyState&&this.beginDrag(i,t.event),t.type===a.POINTERMOVE?this.noPreventContextMenu||2!==t.event.button||1!==t.event.buttons?this.hasManFlags(1)&&!this.hasManFlags(8)?(e.skipNextObservers=!0,o||this.hasManipulatedMode(1792)?this.doRot(i):this.doPos(i)):this._radix.highlighted=this._radix.intersect(i):(this.setManipulatedNodeWorldMatrix(this._firstTransform),this.setManFlags(8)):t.type===a.POINTERDOWN&&0===t.event.button?(this._manipulatedMode=this._radix.intersect(i),0!==this._manipulatedMode&&(e.skipNextObservers=!0,this.beginDrag(i,t.event),this.hasManipulatedMode(1792)?this.doRot(i):this.doPos(i))):t.type===a.POINTERUP&&(this.hasManFlags(1)&&(e.skipNextObservers=!0),this._radix.highlighted=this._radix.intersect(i),0===t.event.button&&this.endDragMode())}},h.prototype.beginDrag=function(t,e){this._firstMousePos=t,this._prevMousePos=this._firstMousePos.clone(),this._shiftKeyState=e.shiftKey;var i=this.getManipulatedNodeWorldMatrix();this._pos=i.getTranslation(),this._right=i.getRow(0).toVector3(),this._up=i.getRow(1).toVector3(),this._view=i.getRow(2).toVector3(),this._oldPos=this._pos.clone(),this._firstTransform=i.clone(),this._flags|=3},h.prototype.endDragMode=function(){this.clearManFlags(9)},h.prototype.doRot=function(t){if(this.hasManFlags(2))return void this.clearManFlags(2);var e=t.x-this._prevMousePos.x,i=t.y-this._prevMousePos.y,n=this._scene.getEngine().getRenderingCanvasClientRect(),r=e/n.width*Math.PI*2*this._rotationFactor,s=i/n.height*Math.PI*2*this._rotationFactor;if(this.rotationStep){var a=r%this.rotationStep;r-=a,a=s%this.rotationStep,s-=a}var h=o.Identity();this.hasManipulatedMode(257)?h=o.RotationX(s):this.hasManipulatedMode(514)?h=o.RotationY(s):this.hasManipulatedMode(1028)?h=o.RotationZ(s):(this.hasManipulatedMode(48)&&(h=h.multiply(o.RotationX(s))),this.hasManipulatedMode(80)&&(h=h.multiply(o.RotationY(r))),this.hasManipulatedMode(32)&&(h=h.multiply(o.RotationZ(s))),this.hasManipulatedMode(32)&&(h=h.multiply(o.RotationZ(r))));var l=h.multiply(this._firstTransform);this.setManipulatedNodeWorldMatrix(l)},h.prototype.doPos=function(t){var e=i.Zero(),r=this._scene.createPickingRay(t.x,t.y,o.Identity(),this._scene.activeCamera);if(this.hasManipulatedMode(112)){var s,a;this.hasManipulatedMode(16)?s=n.FromPoints(this._pos,this._pos.add(this._right),this._pos.add(this._up)):this.hasManipulatedMode(32)?s=n.FromPoints(this._pos,this._pos.add(this._right),this._pos.add(this._view)):this.hasManipulatedMode(64)&&(s=n.FromPoints(this._pos,this._pos.add(this._up),this._pos.add(this._view)));var l=.06;if(Math.abs(i.Dot(s.normal,r.direction))<l)return;var c=r.intersectsPlane(s);if(a=h.ComputeRayHit(r,c),this.hasManFlags(2))return this._flags&=-3,void(this._prevHit=a);e=a.subtract(this._prevHit)}else if(0!==(7&this._manipulatedMode)){var s,p,a,u;if(this.hasManFlags(2)){var d=this.setupIntersectionPlanes(this._manipulatedMode);if(s=d.p0,p=d.p1,Math.abs(i.Dot(s.normal,r.direction))>Math.abs(i.Dot(p.normal,r.direction))){var c=r.intersectsPlane(s);a=h.ComputeRayHit(r,c);var _=-5;this._flags&=_}else{var c=r.intersectsPlane(p);a=h.ComputeRayHit(r,c),this._flags|=4}return this._flags&=-3,void(this._prevHit=a)}var f,d=this.setupIntersectionPlane(this._manipulatedMode,this.hasManFlags(4));s=d.plane,f=d.axis;var c=r.intersectsPlane(s);a=h.ComputeRayHit(r,c),e=a.subtract(this._prevHit),u=i.Dot(f,e),e=f.multiplyByFloats(u,u,u)}this.translationStep&&(e.x-=e.x%this.translationStep,e.y-=e.y%this.translationStep,e.z-=e.z%this.translationStep);var g=this._firstTransform.clone();g.setTranslation(g.getTranslation().add(e)),this._pos=g.getTranslation(),this.setManipulatedNodeWorldMatrix(g)},h.prototype.hasManipulatedMode=function(t){return 0!==(this._manipulatedMode&t)},h.prototype.hasManFlags=function(t){return 0!==(this._flags&t)},h.prototype.clearManFlags=function(t){return this._flags&=~t,this._flags},h.prototype.setManFlags=function(t){return this._flags|=t,this._flags},h.ComputeRayHit=function(t,e){return t.origin.add(t.direction.multiplyByFloats(e,e,e))},h.prototype.setManipulatedNodeWorldMatrix=function(t){if(this._manipulatedNode&&this._manipulatedNode instanceof r){var e=this._manipulatedNode;e.parent&&(t=t.multiply(e.parent.getWorldMatrix().clone().invert()));var o=i.Zero(),n=i.Zero(),a=new s;t.decompose(n,a,o),e.position=o,e.rotationQuaternion=a,e.scaling=n}},h.prototype.getManipulatedNodeWorldMatrix=function(){return this._manipulatedNode?this._manipulatedNode instanceof r?this._manipulatedNode.getWorldMatrix():void 0:null},h.prototype.setupIntersectionPlane=function(t,e){var o,n=this.setupIntersectionPlanes(t),r=e?n.p1:n.p0;switch(t){case 1:o=this._right;break;case 2:o=this._up;break;case 4:o=this._view;break;default:o=i.Zero()}return{plane:r,axis:o}},h.prototype.setupIntersectionPlanes=function(t){var e,i;switch(t){case 1:e=n.FromPoints(this._pos,this._pos.add(this._view),this._pos.add(this._right)),i=n.FromPoints(this._pos,this._pos.add(this._right),this._pos.add(this._up));break;case 2:e=n.FromPoints(this._pos,this._pos.add(this._up),this._pos.add(this._right)),i=n.FromPoints(this._pos,this._pos.add(this._up),this._pos.add(this._view));break;case 4:e=n.FromPoints(this._pos,this._pos.add(this._view),this._pos.add(this._right)),i=n.FromPoints(this._pos,this._pos.add(this._view),this._pos.add(this._up))}return{p0:e,p1:i}},h.prototype.getRayPosition=function(t){var i=this._scene.getEngine().getRenderingCanvasClientRect(),o=t.clientX-i.left,n=t.clientY-i.top;return new e(o,n)},h.prototype.renderManipulator=function(){if(this._manipulatedNode&&this._manipulatedNode instanceof r){var t=this._manipulatedNode,e=t.getWorldMatrix(),n=i.Distance(this._scene.activeCamera.position,e.getTranslation()),a=this._scene.getEngine().getRenderWidth(),h=20*this.fromScreenToWorld(a/100,n),l=i.Zero(),c=i.Zero(),p=s.Identity(),u=o.Scaling(h,h,h).multiply(e);u.decompose(l,p,c),this._radix.setWorld(c,p,l)}},h.prototype.fromScreenToWorld=function(t,e){var i=this._scene.activeCamera,n=this._scene.createPickingRay(0,0,o.Identity(),i,!0),r=this._scene.createPickingRay(t,0,o.Identity(),i,!0),s=h.evalPosition(n,e),a=h.evalPosition(r,e);return a.x-s.x},h.evalPosition=function(t,e){return t.origin.add(t.direction.multiplyByFloats(e,e,e))},h}();t.ManipulatorInteractionHelper=h}(ManipulationHelpers||(ManipulationHelpers={}));var ManipulationHelpers;!function(t){var e=BABYLON.PointerEventTypes,i=BABYLON.AbstractMesh,o=function(){function o(t){var e=this;this._actionStack=new Array,this._scene=t,this._pointerObserver=this._scene.onPointerObservable.add(function(t,i){return e.pointerCallback(t,i)},-1,!0)}return Object.defineProperty(o.prototype,"currentAction",{get:function(){return 0===this._actionStack.length?1:this._actionStack[this._actionStack.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"manipulator",{get:function(){return this._manipulator||(this._manipulator=new t.ManipulatorInteractionHelper(this._scene)),this._manipulator},enumerable:!0,configurable:!0}),o.prototype.pointerCallback=function(t,i){switch(this.detectActionChanged(t,i),this.currentAction){case 1:this.doSelectorInteraction(t,i);break;case 2:t.type&(e.POINTERUP|e.POINTERWHEEL)&&this._actionStack.pop()}},o.prototype.doSelectorInteraction=function(t,o){if(o.skipNextObservers=!0,t.type===e.POINTERUP&&0===t.event.button){var n;if(t.pickInfo.hit&&(n=t.pickInfo.pickedMesh),this._pickedNode===n)return n.showBoundingBox=!n.showBoundingBox,void(n.showBoundingBox===!1&&(this.manipulator.detachManipulatedNode(this._pickedNode),this._pickedNode=null));if(this._pickedNode){if(this._pickedNode instanceof i){var r=this._pickedNode;r.showBoundingBox=!1}this.manipulator.detachManipulatedNode(this._pickedNode),this._pickedNode=null}n&&(this._pickedNode=n,n.showBoundingBox=!0,this.manipulator.attachManipulatedNode(this._pickedNode))}},o.prototype.detectActionChanged=function(t,i){if(1===this.currentAction){if(t.type===e.POINTERDOWN&&!t.pickInfo.hit)return void this._actionStack.push(2);if(t.type===e.POINTERWHEEL)return void this._actionStack.push(2)}},o.CameratorSwitchThreshold=4,o}();t.SimpleInteractionHelper=o}(ManipulationHelpers||(ManipulationHelpers={}));var ManipulationHelpers;!function(t){var e=function(){function t(){}return t.prototype.render=function(){this.renderLight,this.renderManipulator},t}();t.SymbolicVisualHelper=e}(ManipulationHelpers||(ManipulationHelpers={}));